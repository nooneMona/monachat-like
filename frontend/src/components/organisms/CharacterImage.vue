<template>
  <div class="character-image">
    <!-- 自サーバーに向けて取得したものを展開するため -->
    <!-- eslint-disable-next-line vue/no-v-html -->
    <div v-if="fetchedSVGText !== ''" class="character-svg" v-html="characterSVG" />
    <!-- TODO: ChatCharacterに移譲する -->
    <div v-show="isVisibleStat" class="stat-panel-frame">
      <StatPanel :text="user.stat" />
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, ref, watch } from "vue";
import axios from "axios";
import { Stat } from "@/domain/stat";
import defaultCharhanSVG from "@/stores/defaultCharhan";
import StatPanel from "@/components/molecules/character/StatPanel.vue";
import { ChatCharacterUser } from "@/domain/type";

const props = defineProps<{
  user: Pick<ChatCharacterUser, "type" | "scl" | "hexValue" | "stat">;
  depthRate: number;
  isKBMode: boolean;
  isSilent: boolean;
}>();
const emits = defineEmits<{ (e: "imageUpdated"): void }>();

// リアクティブ
const fetchedSVGText = ref("");

const characterOpacity = computed(() => (props.isSilent ? 0.3 : 1));
// 画像のパス
const imageFilePath = computed(() => {
  // NOTE: 存在しないキャラコかどうかは問い合わせがないとわからないため、
  //       バリデーションはここでは行わない。空白も存在しないキャラコかわからない扱い。
  // TODO: サニタイズでは完全なディレクトリトラバーサルの対策になっていない
  const sanitizedType = props.user.type.replace(/[^0-9a-z_-]/gi, "");
  if (props.isKBMode) {
    return `/img/kb/${sanitizedType}.svg`;
  }
  return `/img/svg/${sanitizedType}.svg`;
});
const characterSVG = computed(() => {
  let text = fetchedSVGText.value;
  text = text.replaceAll(`style="fill:white;"`, `fill="${props.user.hexValue}"`);
  text = text.replaceAll(`stroke-width="0.05"`, `stroke-width="0.5"`);
  return text.replaceAll(`fill="#ffffff"`, `fill="${props.user.hexValue}"`);
});
const scale = computed(() => {
  const oneValue = props.depthRate;
  if (props.user.scl === 100) {
    return `scale(${oneValue}, ${oneValue})`;
  }
  return `scale(${-oneValue}, ${oneValue})`;
});
const isVisibleStat = computed(() => {
  const stat = Stat.create(props.user.stat);
  return stat.isVisible();
});

const fetchSVGData = async () => {
  if (props.user.type == null) {
    // NOTE: 仮に正しい順番(e.g. undefined->mona)にリクエストを送信しても、
    // type=undefinedの状態のリクエストのレスポンスが最後に来る(e.g. mona->undefined)とチャーハンになってしまう。
    return;
  }
  try {
    const svgRes = await axios({
      url: imageFilePath.value,
      method: "GET",
      responseType: "text",
    });
    fetchedSVGText.value = svgRes.data;
  } catch {
    fetchedSVGText.value = defaultCharhanSVG;
  }
};

watch(
  imageFilePath,
  () => {
    // NOTE: パスが変わるということはデータも変わる 例: KBモードの切替
    fetchSVGData();
  },
  { immediate: true },
);
watch([fetchedSVGText], () => {
  // NOTE: svgにセットされた瞬間はまだ描画されていない
  //       => タスクキューに積んで遅延させる
  setTimeout(() => {
    emits("imageUpdated");
  }, 0);
});
</script>

<style lang="scss" scoped>
.character-image {
  position: relative;
  opacity: v-bind(characterOpacity);

  .character-svg {
    transform-origin: center bottom;
    transform: v-bind(scale);
  }

  .stat-panel-frame {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
  }
}
</style>
